#:kivy 1.10.0

#:import SlideTransition kivy.uix.screenmanager.SlideTransition
#:import RecycleView kivy.uix.recycleview
#:import QRCodeWidget kivy_garden.qrcode
# import ZbarQrcodeDetector android-zbar-qrcode.main
#:import ak asynckivy
#:import asyncio asyncio
#:import MDDropdownMenu kivymd.uix.menu.MDDropdownMenu
#:import MDNavigationLayout kivymd.uix.navigationdrawer.navigationdrawer.MDNavigationLayout

# QR SCANNER
# : import ZBarCam kivy_garden.zbarcam.ZBarCam


<Tab>
    MDLabel:
        text: root.content_text
        pos_hint: {"center_x": .5, "center_y": .5}

<UTXOListItem>:
    on_release: self.open_utxo_menu()

MDScreen:
    BoxLayout:
        orientation: "vertical"
        MDTopAppBar:
            id: toolbar
            title: "Brainbow"
            pos_hint: {"top": 1}
            md_bg_color: "#252525"
            #anchor_title: "center"
            #icon: "fingerprint"
            #left_action_items: [["menu", lambda x: app.menu_button_handler(self)]]
            # left_action_items: [['menu', lambda x: root.ids.nav_drawer.set_state("open")]]
            left_action_items: [["menu", lambda x: app.nav_drawer_handler()]]
        Widget:
    MDNavigationLayout:
        x: toolbar.height
        size_hint_y: 1.0 - toolbar.height/root.height

        MDScreenManager:
            id: sm
            LoginScreen:
                name: "login"
                AnchorLayout:
                    BoxLayout:
                        size_hint: 0.8, 0.55
                        spacing: 3
                        orientation: "vertical"
                        MDTextField:
                            id: email_field
                            hint_text: "Email/Username/Salt"
                            color_mode: "accent"
                            write_tab: False
                            required: True
                            font_size: '21sp'
                        MDTextField:
                            id: pass_field
                            hint_text: "Passphrase"
                            color_mode: "accent"
                            write_tab: False
                            password: True
                            required: True
                            font_size: '21sp'
                        MDTextField:
                            id: confirm_field
                            hint_text: "Repeat Passphrase"
                            color_mode: "accent"
                            write_tab: False
                            password: True
                            required: True
                            font_size: '21sp'
                        BoxLayout:
                            MDCheckbox:
                                id: bech32_checkbox
                                size_hint: None, None
                                size:  dp(33), dp(33)
                                opacity: 0
                                active: False
                                disabled: True # bech32 implementation seems broken right now. not sure if it ever worked
                        MDRaisedButton:
                            size_hint_x: 1
                            text: "Let's get started"
                            id: login_button
                            md_bg_color: "#252525"
                            on_release: app.login()
                            font_size: '18sp'

                        MDLabel:
                            size: self.size
                            opacity: 0.85
                            halign: 'center'
                            font_size: '12sp'
                            text: "\n\n\n\n\n\n\n\n\n\n\nBrainbow is of course offered without any warranty of any kind; if you lose your bitcoin due to a bug in our software, your keystrokes being recorded on a malware-infested XP rig from 2003, a weak passphrase, or even a typo, we are sorry in the most respectful way, but we cannot help you.\n\nJust don't forget your salt and passphrase."


            MainScreen:
                name: "main"
                id: main
                MDTabs
                    tab_display_mode: "icons"
                    on_tab_switch: app.give_current_tab_name(*args)
                    #on_slide_progress: print('hello')
                    background_color: "#4d4d4d"
                    tab_bar_height:  dp(52)
                    id: main_tabs
                    Tab:
                        name: "balance"
                        title: "TRANSACTIONS"
                        title_icon_mode: "Top"
                        icon: "database-check"
                        BoxLayout:
                            orientation: "vertical"
                            BalanceLabel:
                                id: balance_label
                                font_style: "H4"
                                theme_text_color: "Primary"
                                halign: "center"
                                size_hint_y: None
                                height: self.texture_size[1] + dp(48)
                                on_release: app.toggle_balance_label()
                            RecycleView:
                                id: recycleView
                                viewclass: "ListItem"
                                RecycleBoxLayout:
                                    default_size: None, dp(56)
                                    default_size_hint: 1, None
                                    size_hint_y: None  # redefinition?
                                    height: self.minimum_height
                                    orientation: "vertical"

                    Tab:
                        name: "send"
                        id: send
                        title: "SEND"
                        title_icon_mode: "Top"
                        icon: "database-export"
                        #icon: "database-arrow-right"
                        AnchorLayout:
                            BoxLayout:
                                size_hint: 0.9, 0.75
                                orientation: "vertical"
                                spacing: 9
                                BoxLayout:
                                    size_hint: 1, 0.2
                                    spacing: 5
                                    FloatInput:
                                        id: spend_amount_input
                                        text: app.current_coin
                                        hint_text: app.units
                                        color_mode: "accent"
                                        write_tab: False
                                        on_text: app.update_amounts(self.text, "coin")
                                        on_text: app.set_amount_error(self.text)
                                        on_text_validate: app.set_amount_error(self.text)
                                        on_focus: app.set_amount_error(self.text)
                                    FloatInput:
                                        text: app.current_fiat
                                        hint_text: app.currency
                                        color_mode: "accent"
                                        write_tab: False
                                        on_text: app.update_amounts(self.text, "fiat")
                                MDLabel:
                                    id: send_balance
                                    size_hint: 1, 0.2
                                    theme_text_color: "Primary"
                                    font_style: "H6"

                                BoxLayout:
                                    size_hint: 1, 0.6
                                    spacing: 25
                                    FloatInput:
                                        id: fee_input
                                        helper_text: "Miner Fee: sat/byte"
                                        helper_text_mode: "persistent"
                                        color_mode: "accent"
                                        write_tab: False
                                        disabled: True
                                        on_text: app.fee_input_handler()
                                    MDRaisedButton:
                                        id: fee_button
                                        size_hint: 0.5, 1
                                        #size_hint_x: 1
                                        text: "Normal Fee"
                                        on_release: app.fee_button_handler()
                                BoxLayout:
                                    size_hint: 1, 0.6
                                    spacing: 5
                                    MDTextField:
                                        id: address_input
                                        helper_text: "Enter Address"
                                        helper_text_mode: "persistent"
                                        color_mode: "accent"
                                        write_tab: False
                                        on_text: app.set_address_error(self.text)
                                        on_text_validate: app.set_address_error(self.text)
                                        on_focus: app.set_address_error(self.text)


                                BoxLayout:
                                    size_hint: 1, 0.6
                                    spacing: 5
                                    MDRaisedButton:
                                        id: send_button
                                        #size_hint: 0.5, 1
                                        size_hint_x: 1
                                        text: "Send TX"
                                        on_release: asyncio.create_task(app.send_button_handler())

                                MDFloatingActionButton:
                                    icon: "qrcode-scan"
                                    opposite_colors: True
                                    elevation_normal: 8
                                    pos_hint: {"center_x": 0.5, "center_y": 0.2}
                                    id: camera_button
                                    on_release: app.start_zbar()


                                MDFloatingActionButton:
                                    icon: "credit-card-scan-outline"
                                    opposite_colors: True
                                    elevation_normal: 8
                                    pos_hint: {"center_x": 0.5, "center_y": 0.2}
                                    id: nfc_button
                                    on_release: app.start_nfc_tap()


                    Tab:
                        name: "recieve"
                        title: "RECIEVE"
                        title_icon_mode: "Top"
                        icon: "database-import"
                        AnchorLayout:
                            BoxLayout:
                                size_hint: 0.9, 0.8
                                spacing: 3
                                orientation: "vertical"
                                BoxLayout:
                                    size_hint: 1, 0.2
                                    spacing: 5
                                    FloatInput:
                                        text: app.current_coin
                                        hint_text: app.units
                                        color_mode: "accent"
                                        write_tab: False
                                        on_text: app.update_amounts(self.text, "coin")
                                    FloatInput:
                                        text: app.current_fiat
                                        hint_text: app.currency
                                        color_mode: "accent"
                                        write_tab: False
                                        on_text: app.update_amounts(self.text, "fiat")
                                MDCard:
                                    size_hint: None, None
                                    size: dp(300), dp(320)
                                    pos_hint: {"center_x": 0.5}
                                    BoxLayout:
                                        orientation:"vertical"
                                        padding: dp(10)
                                        spacing: 5
                                        on_touch_down: app.copy_current_address_to_clipboard()
                                        MDLabel:
                                            id: addr_label
                                            text_color: "#000000"
                                            font_style:"Body2"
                                            size_hint_y: None
                                            height: dp(40)
                                        QRCodeWidget:
                                            id: addr_qrcode
                                            show_border: False

                    Tab:
                        name: "addresses"
                        id: addresses
                        icon: "map-marker-multiple"
                        title: "ADDRESSES"
                        title_icon_mode: "Top"
                        tab_padding: [10, 0, 0,0]
                        BoxLayout:
                            orientation: "vertical"
                            RecycleView:
                                id: addresses_recycle_view
                                viewclass: "TwoLineListItem" #TwoLineIconListItem
                                RecycleBoxLayout:
                                    default_size: None, None
                                    default_size_hint: 1, None
                                    size_hint_y: None
                                    height: self.minimum_height
                                    orientation: "vertical"
                    Tab:
                        name: "utxos"
                        icon: "database-marker"
                        title: "UTXOs (Coins)"
                        title_icon_mode: "Top"
                        tab_padding: [10, 0, 0,0]
                        BoxLayout:
                            orientation: "vertical"
                            RecycleView:
                                id: utxoRecycleView
                                viewclass: "UTXOListItem"
                                RecycleBoxLayout:
                                    default_size: None, None
                                    default_size_hint: 1, None
                                    size_hint_y: None
                                    height: self.minimum_height
                                    orientation: "vertical"

            WaitScreen:
                name: "wait"
                AnchorLayout:
                    MDSpinner:
                        size_hint: None, None
                        size: dp(242), dp(242)
                        pos_hint: {"center_x": 0.5, "center_y": 0.5}
                        palette:
                            [0, 0, 0, 1],
                        line_width: dp(1.25)
                MDLabel:
                    id: wait_text
                    text: "Loading..."
                    theme_text_color: "Primary"
                    font_style: "H4"
                    size_hint: 0.7, None
                    halign: "center"
                    pos_hint: {"center_x": 0.5, "center_y": 0.5}

                MDLabel:
                    id: wait_text_small
                    size: self.size
                    font_size: '11sp'
                    text: "-"
                    theme_text_color: "Primary"
                    size_hint: 0.7, None
                    halign: "center"
                    pos_hint: {"center_x": 0.5, "center_y": 0.95}




            YPUBScreen:
                name: "ypub"
                MDCard:
                    size_hint: None, None
                    size: dp(320), dp(360)
                    pos_hint: {"center_x": 0.5, "center_y": 0.55}
                    BoxLayout:
                        orientation:"vertical"
                        padding: dp(10)
                        spacing: 5
                        MDLabel:
                            id: ypub_label
                            theme_text_color: "ContrastParentBackground"
                            font_style: "Body2"
                            size_hint_y: None
                            height: dp(70)
                        QRCodeWidget:
                            id: ypub_qrcode
                            show_border: False
                MDRaisedButton:
                    size_hint: 0.5, 0.07
                    pos_hint: {"center_x": 0.5, "center_y": 0.13}
                    text: "Go Back"
                    id: ypub_back_button
                    on_release: app.root.ids.sm.current = "main"

            SeedScreen:
                name: "seed"
                MDCard:
                    size_hint: None, None
                    size: dp(320), dp(360)
                    pos_hint: {"center_x": 0.5, "center_y": 0.55}
                    BoxLayout:
                        orientation:"vertical"
                        padding: dp(10)
                        spacing: 5
                        MDLabel:
                            id: seed_label
                            theme_text_color: "ContrastParentBackground"
                            font_style:"Body2"
                            size_hint_y: None
                            height: dp(70)
                        QRCodeWidget:
                            id: seed_qrcode
                            show_border: False
                MDRaisedButton:
                    size_hint: 0.5, 0.07
                    pos_hint: {"center_x": 0.5, "center_y": 0.13}
                    text: "Go Back"
                    id: seed_back_button
                    on_release: app.root.ids.sm.current = "main"




    MDNavigationLayout:
        MDNavigationDrawer:
            id: nav_drawer
            #type: "standard"
            anchor: "left"
            padding: 16, 22, 12, 16
            #radius: (0, 16, 16, 0) if self.anchor == "left" else (16, 0, 0, 16)
            radius: (0, 0, 0, 0)
            md_bg_color: "#ffffff"
            MDNavigationDrawerMenu:
                MDNavigationDrawerHeader:
                    title: "Brainbow"
                    text: "(no active wallet)"
                    text_color: "#c9c9c9"
                    #source: "brain_nav.png"

                    #spacing: "4dp"
                    padding: "12dp", 0, 0, "56dp"

                #MDNavigationDrawerLabel:
                #    text: "Wallet"

                MDNavigationDrawerItem:
                    icon: "database-check"
                    right_text: ""
                    text_right_color: "#4a4939"
                    text: "Transactions"
                    #text_color: "#c9c9c9"
                    #selected_color: "#c9c9c9"
                    id: nav_drawer_item_transactions
                    on_release: app.goto_screen('main', 'TRANSACTIONS')

                MDNavigationDrawerItem:
                    icon: "database-import"
                    text: "Recieve"
                    on_release: app.goto_screen('main', 'RECIEVE')

                MDNavigationDrawerItem:
                    icon: "database-export"
                    text: "Send"
                    on_release: app.goto_screen('main', 'SEND')

                MDNavigationDrawerDivider:

                #MDNavigationDrawerItem:
                #    icon: "cellphone-nfc"
                #    text: "Test Bottom Sheed"
                #    on_release: app.open_sheet()



                MDNavigationDrawerItem:
                    icon: "map-marker-multiple"
                    text: "Addresses"
                    on_release: app.goto_screen('main', 'ADDRESSES')

                MDNavigationDrawerItem:
                    icon: "database-marker"
                    text: "UTXOs (Coins)"
                    on_release: app.goto_screen('main', "UTXOs (Coins)")

                    # on_release: app.nfc_toggle()

                #MDNavigationDrawerLabel:
                #    text: "Labels"
                #    spacing: "16dp"



                MDNavigationDrawerDivider:

                #MDNavigationDrawerLabel:
                #    text: "Help and Feedback"
                #MDNavigationDrawerItem:
                #    icon: "twitter"
                #    text: "Twitter @bitcoinbrainbow"

                #MDNavigationDrawerLabel:
                #    text: "Version: 0.0.1.testnet"
                #    text_color: "#c9c9c9"

                #MDNavigationDrawerDivider:

                MDNavigationDrawerItem:
                    icon: "cellphone-nfc"
                    text: "NFC On/Off"
                    on_release: app.nfc_toggle()

                MDNavigationDrawerItem:
                    icon: "database-cog"
                    text: "Settings"

                MDNavigationDrawerDivider:


                MDNavigationDrawerLabel:
                    text: "Wallet Information and Export"

                MDNavigationDrawerItem:
                    icon: "database-arrow-down-outline"
                    text: "Extended Public Key"
                    on_release: app.get_tab_list()

                MDNavigationDrawerItem:
                    icon: "database-arrow-down"
                    text: "Wallet Import Format"

                MDNavigationDrawerItem:
                    icon: "database-off"
                    text: "Disconnet Wallet and Exit"
                    on_release: app.logoff()





#<ListItem>:
#    on_release: self.on_release()
#    IconLeftSampleWidget:
#        icon: self.parent.parent.icon
